<!DOCTYPE html>

<html>

<head>
    <meta charset="UTF-8">
    <title>Computer Lab Check</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href='https://unpkg.com/css.gg@2.0.0/icons/css/menu.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/styles.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <div class="min-h-screen bg-gradient-to-br from-[#0A0D5B] from-20% via-[#040C34] via-30% to-black to-50% ...">
        <!--Navbar-->
        <div class="w-full">
            <div class="px-4 py-4 flex justify-start items-center space-x-3 text-white text-[1.3rem] font-bold">
                <img class="w-[2rem]" src="/assets/img/sara-logo.png">
                <h4>Com Lab</h4>
            </div>
        </div>
        <!--Register flex-->
        <div class="w-full mt-[150px] pl-5 text-white text-[20px] font-bold">
            <div class="w-max flex items-center">
                <h1>Register for LAB</h1>
                <div class="relative inline-block text-left">
                    <div class="bg-gradient-to-r from-[#70A5FD] to-[#FD70C5] p-[3px] ml-2 rounded-[40px]">
                        <div class="flex items-center">
                            <button onclick="pressDropdown()" class="focus:outline-none">
                                <div class="bg-[#272727] px-[15px] rounded-[40px]">
                                    <h4 id="roomNumberLabel" class="text-white text-[12px]">Select</h4>
                                </div>
                            </button>
                        </div>
                        <div id="dropdownmenu"
                            class="origin-top-right h-0 transition-all duration-[700ms] overflow-y-auto absolute right-0 mt-2 w-max rounded-md shadow-lg bg-[#272727] border-[0px] border-l-[#70A5FD] border-r-[#FD70C5] border-y-[#bb8be0]">
                            <!-- Dropdown items -->
                            <div class="py-1">
                                <button onclick="keepRoomNumber(123), pressDropdown()" href="#"
                                    class="px-4 py-2 text-sm text-white flex justify-center">123</button>
                                <button onclick="keepRoomNumber(125), pressDropdown()"
                                    class="px-4 py-2 text-sm text-white flex justify-center">125</button>
                                <button onclick="keepRoomNumber(126), pressDropdown()"
                                    class="px-4 py-2 text-sm text-white flex justify-center">126</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--Std Input Box-->
        <div id="stdNumberBox" class="mt-[40px] w-full flex justify-center transition-all duration-[700ms]">
            <div class="h-[100px] w-[270px] flex justify-center items-center ">
                <div
                    class="absolute text-white text-end text-[50px] tracking-[25px] w-[250px] flex pl-[40px] items-center h-max">
                    <h1 id="dotLabel0" class="">•</h1>
                    <h1 id="dotLabel1" class="">•</h1>
                    <h1 id="dotLabel2" class="">•</h1>
                    <h1 id="dotLabel3" class="">•</h1>
                    <h1 id="dotLabel4" class="">•</h1>
                </div>
                <input
                    class="relative rounded-[20px] pl-[50px] flex justify-center items-center text-[30px] tracking-[1rem] text-white font-bold h-full w-full  bg-transparent border-[3px] border-l-[#70A5FD] border-r-[#FD70C5] border-y-[#bb8be0]"
                    type="number" name="idNumber" id="idNumber" maxlength="5"
                    oninput="updateDotInput(value), submitToOutCheck(event), limitInputLength(event)">
            </div>
        </div>
        <!--Note Box-->
        <div class="flex items-center">
            <div class="text-[25px] text-white pl-5 flex items-center space-x-3 py-5">
                <button onclick="addNote()" id="addnotecheck" class="fa fa-circle-o"></button>
                <div>
                    <h4 class="text-white font-bold text-[16px]">Add Note</h4>
                </div>
            </div>
        </div>
        <div id="notebox" class="w-full justify-center items-start hidden">
            <textarea id="note" name="note"
                class="h-max w-[270px] text-[12px] text-white bg-white/20 pl-[10px] rounded-[10px] resize-y"
                placeholder="Enter note..."></textarea>
        </div>

        <!--Message Box-->
        <div id="message"
            class="hidden w-[60%] h-max bg-[#ca253b] text-white px-4 py-3 rounded-[20px] absolute bottom-5 right-5 shadow-md">

        </div>

        <div class="w-full h-max flex justify-center items-center mt-[50px]">
            <div id="submitBox"
                class="transition-all duration-[700ms] bg-white/50 from-[#21B914] to-[#257BCA] p-[3px] rounded-[20px]">
                <button id="submit" type="submit" onclick="submitFunc(event)"
                    class="w-[150px] max-h-[30px] overflow-hidden space-x-[5px] transition-all duration-[700ms] flex justify-between items-center px-5 p-[3px] rounded-[20px] bg-[#272727] text-white text-[20px] font-bold">
                    <h4 id="submitText">Login</h4>
                    <i id="submitIcon" class="fa fa-arrow-right" aria-hidden="true"></i>
                </button>
            </div>
        </div>

        <!--ใช้งานนานที่สุดวันนี้-->
        <div class="w-full flex justify-center mt-[300px]">
            <div class="w-full h-[500px] mx-5 rounded-[20px]  bg-white/20">
                <div class="flex justify-start items-center text-white text-[20px] font-bold mx-5 mt-5 mb-3">
                    <h4>ใช้งานนานที่สุดวันนี้ :</h4>
                </div>
                <div class="w-full h-[1px] bg-white/50"></div>
                <div class="w-full px-4 flex justify-between my-5">
                    <div id="nameLogList" class="text-white">
                    </div>
                    <div id="timeLogList" class="text-white">
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
<script>
    //global var
    var stdName;
    var isUserOut;


    //frontend script
    let labDropdownOpen = false;
    function pressDropdown() {
        labDropdownOpen = !labDropdownOpen;

        if (labDropdownOpen) {
            document.getElementById("dropdownmenu").classList.replace("h-0", "h-[100px]");
            document.getElementById("dropdownmenu").classList.replace("border-[0px]", "border-[3px]");

            document.getElementById("stdNumberBox").classList.replace("mt-[40px]", "mt-[150px]");
        } else {
            document.getElementById("dropdownmenu").classList.replace("h-[100px]", "h-0");
            document.getElementById("dropdownmenu").classList.replace("border-[3px]", "border-[0px]");

            document.getElementById("stdNumberBox").classList.replace("mt-[150px]", "mt-[40px]");
        }
    }

    //Keep room number
    var room;
    function keepRoomNumber(roomNumber) {
        room = roomNumber;
        document.getElementById("roomNumberLabel").innerHTML = `${room}`;
        console.log(room)
    }

    //Update Dot in StdNumber Input
    function updateDotInput(stdInput) {
        for (let i = 0; i < 5; i++) {
            if (stdInput[i]) {
                document.getElementById(`dotLabel${i}`).classList.add('text-transparent')
            }
            else {
                document.getElementById(`dotLabel${i}`).classList.remove('text-transparent')
            }
        }
    }

    //Limit Std Number
    function limitInputLength(event) {
        const input = event.target;
        if (input.value.length > 5) {
            input.value = input.value.slice(0, 5);
        }
    }

    //Add Note Box
    var isAddNoteCheck = false;
    function addNote() {
        isAddNoteCheck = !isAddNoteCheck;
        if (isAddNoteCheck) {
            document.getElementById("addnotecheck").classList.replace("fa-circle-o", "fa-check-circle-o")
            document.getElementById("notebox").classList.replace('hidden', 'flex');
        } else {
            document.getElementById("addnotecheck").classList.replace("fa-check-circle-o", "fa-circle-o")
            document.getElementById("notebox").classList.replace('flex', 'hidden');
        }
    }

    //Submit when press enter
    document.addEventListener('DOMContentLoaded', function () {
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                document.getElementById('submit').click();
            }
        });
    });

    // Define an array to hold user data
    let userLogs = [];
    let intervalIDArray = [];
    // Function to Add User Log in List
    function updateUserLogs(stdName, isLogOut) {
        let userIndex = userLogs.findIndex(user => user.name === stdName);

        if (userIndex !== -1) {
            if (isLogOut) {
                const timeLogList = document.getElementById('timeLogList').getElementsByTagName('h4');
                timeLogList[userIndex].classList.add('text-red-600');

                clearInterval(intervalIDArray[userIndex]);
                intervalIDArray[userIndex] = null;
            } else {
                // If user is found, update their data
                const currentUser = userLogs[userIndex];
                currentUser.time++;

                const timeLogList = document.getElementById('timeLogList').getElementsByTagName('h4');
                timeLogList[userIndex].textContent = formatTime(currentUser.time);
                timeLogList[userIndex].classList.remove('text-red-600');

                // Restart the timer for the existing user
                const timerInterval = setInterval(() => {
                    currentUser.time++;
                    timeLogList[userIndex].textContent = formatTime(currentUser.time);
                }, 1000);
                intervalIDArray[userIndex] = timerInterval;
            }
        } else {
            // If the user is not found, add a new entry
            const newUser = {
                name: stdName,
                time: 0,
            };

            userLogs.push(newUser);

            const newNameLog = document.createElement('h4');
            newNameLog.textContent = newUser.name;

            const newTimeLog = document.createElement('h4');
            newTimeLog.textContent = formatTime(newUser.time);

            const nameLogList = document.getElementById('nameLogList');
            const timeLogList = document.getElementById('timeLogList');

            nameLogList.appendChild(newNameLog);
            timeLogList.appendChild(newTimeLog);

            if (!isLogOut) {
                const timerInterval = setInterval(() => {
                    newUser.time++;
                    newTimeLog.textContent = formatTime(newUser.time);
                }, 1000);
                intervalIDArray.push(timerInterval);
            } else {
                intervalIDArray.push(null);
            }
        }
    }

    // Function to format time
    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const remainingSeconds = seconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
    }











    function submitToOutCheck(event) {
        document.getElementById("submitText").innerHTML = "Login";
        document.getElementById("submit").classList.replace('w-[300px]', 'w-[150px]')
        try {
            document.getElementById("submitBox").classList.replace('bg-gradient-to-r', 'bg-white/50')
        } catch { }
        event.preventDefault();

        // Get the input values
        const idNumber = document.getElementById("idNumber").value;
        const xhttp = new XMLHttpRequest();

        // Send the ID number and note number to the PHP script
        const formData = new FormData();
        formData.append("idNumber", idNumber);
        xhttp.open("POST", "checkIn_or_out.php", true);
        xhttp.send(formData);

        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                // Handle the response from the PHP script
                try {
                    const response = JSON.parse(xhttp.responseText);
                    console.log(response.name, response.idInForm)
                    stdName = response.name;
                    if (response.idInForm == "out") {
                        isUserOut = true;
                        document.getElementById("submitText").innerHTML = `Logout as ${response.name}`;
                        document.getElementById("submit").classList.replace('w-[150px]', 'w-[300px]')
                        document.getElementById("submitBox").classList.replace('bg-white/50', 'bg-gradient-to-r');
                        document.getElementById("submitBox").classList.replace("from-[#21B914]", "from-[#b91414]");
                        document.getElementById("submitBox").classList.replace("to-[#257BCA]", "to-[#ca2588]");
                    }
                    if (response.idInForm == "in") {
                        isUserOut = false;
                        document.getElementById("submitText").innerHTML = `Login as ${response.name}`;
                        document.getElementById("submit").classList.replace('w-[150px]', 'w-[300px]')
                        document.getElementById("submitBox").classList.replace('bg-white/50', 'bg-gradient-to-r')
                        document.getElementById("submitBox").classList.replace("from-[#b91414]", "from-[#21B914]");
                        document.getElementById("submitBox").classList.replace("to-[#ca2588]", "to-[#257BCA]");
                    }
                } catch (e) {
                    console.log("Error: Failed to parse response from PHP script");
                    console.log(e)
                }
            }
        }
    }

    function submitFunc(event) {
        event.preventDefault();

        // Get the input values
        const idNumber = document.getElementById("idNumber").value;
        const note = document.getElementById("note").value;
        room = room;
        const xhttp = new XMLHttpRequest();

        // Check if the required fields have values
        if (!idNumber || !room) {
            messagePopup = document.getElementById("message");
            messagePopup.innerHTML = 'โปรดกรอกข้อมูลให้ครบถ้วน';
            messagePopup.classList.replace('hidden', 'block');
            messagePopup.style.animation = 'slideInFromBottom 0.5s ease';
            setTimeout(function () {
                messagePopup.classList.replace('block', 'hidden');
                messagePopup.innerHTML = "";
            }, 5000);
            return;
        }

        // Send the ID number and note number to the PHP script
        const formData = new FormData();
        formData.append("idNumber", idNumber);
        formData.append("note", note);
        formData.append("room", room);
        xhttp.open("POST", "index.php", true);
        xhttp.send(formData);

        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                // Handle the response from the PHP script
                try {
                    const response = JSON.parse(xhttp.responseText);
                    if (response.status == "success") {
                        document.getElementById("idNumber").value = "";
                        document.getElementById("note").value = "";
                        for (let i = 0; i < 5; i++) {
                            document.getElementById(`dotLabel${i}`).classList.remove('text-transparent')
                        }
                        if (isAddNoteCheck) {
                            document.getElementById("addnotecheck").classList.replace("fa-check-circle-o", "fa-circle-o")
                            document.getElementById("notebox").classList.replace('flex', 'hidden');
                            isAddNoteCheck = false;
                        }
                        //Add to log list
                        const nameLogList = document.getElementById('nameLogList'); // Select the parent element
                        var isfoundNameInList = false;
                        var foundIndex = -1;

                        // Loop through the h4 elements to find the name
                        for (let i = 0; i < nameLogList.children.length; i++) {
                            if (nameLogList.children[i].textContent === stdName) {
                                isfoundNameInList = true;
                                foundIndex = i;
                                break; // Once found, exit the loop
                            }
                        }

                        if (isfoundNameInList) {
                            if (isUserOut == false) {
                                updateUserLogs(stdName, false);
                            }
                            else {
                                updateUserLogs(stdName, true);
                            }
                        } else {
                            updateUserLogs(stdName, false);
                        }


                        //Animation
                        document.getElementById("submitText").innerHTML = "Success";
                        document.getElementById('submitIcon').classList.replace('fa-arrow-right', 'fa-check')
                        document.getElementById("submit").classList.replace('w-[300px]', 'w-[150px]')
                        document.getElementById("submitBox").classList.replace('bg-gradient-to-r', 'bg-green-600')
                        setTimeout(function () {
                            document.getElementById("submitText").innerHTML = "Login";
                            document.getElementById('submitIcon').classList.replace('fa-check', 'fa-arrow-right')
                            document.getElementById("submitBox").classList.replace('bg-green-600', 'bg-white/50')
                        }, 2000);
                    }
                    else if (response.noti === 'ไม่พบเลขห้องปฏิบัติการ ลองใหม่อีกครั้งคุณ') {
                        document.getElementById("idNumber").value = "";
                        document.getElementById("note").value = "";
                        for (let i = 0; i < 5; i++) {
                            document.getElementById(`dotLabel${i}`).classList.remove('text-transparent')
                        }
                        if (isAddNoteCheck) {
                            document.getElementById("addnotecheck").classList.replace("fa-check-circle-o", "fa-circle-o")
                            document.getElementById("notebox").classList.replace('flex', 'hidden');
                            isAddNoteCheck = false;
                        }
                        messagePopup = document.getElementById("message");
                        messagePopup.innerHTML = response.noti + " " + response.name;
                        messagePopup.classList.replace('hidden', 'block');
                        messagePopup.style.animation = 'slideInFromBottom 0.5s ease';
                        setTimeout(function () {
                            messagePopup.classList.replace('block', 'hidden');
                            messagePopup.innerHTML = "";
                        }, 5000);
                        document.getElementById("submitText").innerHTML = "Login";
                        document.getElementById("submitBox").classList.replace('bg-gradient-to-r', 'bg-white/50')
                    }
                    else {
                        messagePopup = document.getElementById("message");
                        messagePopup.innerHTML = 'เลขประจำตัวไม่ถูกต้อง';
                        messagePopup.classList.replace('hidden', 'block');
                        messagePopup.style.animation = 'slideInFromBottom 0.5s ease';
                        setTimeout(function () {
                            messagePopup.classList.replace('block', 'hidden');
                            messagePopup.innerHTML = "";
                        }, 5000);
                    }
                } catch (e) {
                    console.log(e)
                    document.getElementById("message").innerHTML = "Backend not response, Call Admin";
                }
            }
        };
    }
</script>